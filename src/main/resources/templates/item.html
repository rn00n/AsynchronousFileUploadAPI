<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script  src="http://code.jquery.com/jquery-latest.min.js"></script>
</head>
<body>
    <h1>Board Home</h1>
    <img src="data:image/jpg;base64,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">
    <form>
        <div class="form-group">
            <label>아이템 아이디</label>
            <input class="form-control" type="text" id="itemId" name="itemId" value=""/>
        </div>
        <div class="form-group">
            <label>아이템이름</label>
            <input class="form-control" type="text" id="itemName" name="itemName" value=""/>
        </div>
        <div class="form-group">
            <label>가격</label>
            <input class="form-control" type="text" id="price" name="price" value=""/>
        </div>
        <div class="form-group">
            <label>설명</label>
            <input class="form-control" type="text" id="description" name="description"/>
        </div>
        <div class="form-group">
            <label>첨부파일</label>
            <input class="form-control" type="file" id="inputFile" name="picture"/>
        </div>
        <div class="uploadedList"></div>
    </form>
    <div>
        <button class="btn btn-outline-dark" id="listBtn">목록</button>
        <button class="btn btn-outline-dark" id="registerBtn">등록</button>
        <button class="btn btn-outline-dark" id="readBtn">조회</button>
        <button class="btn btn-outline-dark" id="modifyBtn">수정</button>
        <button class="btn btn-outline-dark" id="deleteBtn">삭제</button>
        <button class="btn btn-outline-dark" id="resetBtn">입력삭제</button>
    </div>

    <script>
        $(document).ready(function () {
            function getOriginalName(fileName){
                if(checkImageType(fileName)){
                    return;
                }

                var idx = fileName.indexOf("_") + 1 ;

                return fileName.substr(idx);
            }

            function getThumbnailName(fileName){
                var front = fileName.substr(0,12);
                var end = fileName.substr(12);

                console.log("front : " + front);
                console.log("end : " + end);
                var name = front + "s_" + end;
                console.log(name);
                return name;
            }

            function checkImageType(fileName){
                var pattern = /jpg|gif|png|jpeg/i;

                return fileName.match(pattern);
            }

            $(".uploadedList").on("click", "span", function(event){
                $(this).parent("div").remove();
            });
            $("#inputFile").on("change", function(event){
                console.log("change");

                var files = event.target.files;

                var file = files[0];

                console.log(file);

                var formData = new FormData();

                formData.append("file", file);

                $.ajax({
                    url: "/api/items/upload",
                    data: formData,
                    dataType:"text",
                    processData: false,
                    contentType: false,
                    type: "POST",
                    success: function(data){
                        console.log(data);

                        var str ="";

                        if(checkImageType(data)){
                            str = "<div><a href='/api/items/display?fileName=" + data + "'>"
                                + "<img src='/api/items/display?fileName=" + getThumbnailName(data) + "'/>"
                                + "</a><span>X</span></div>";
                        }
                        else{
                            str = "<div><a href='/api/items/display?fileName=" + data + "'>"
                                + getOriginalName(data) + "</a><span>X</span></div>";
                        }

                        $(".uploadedList").append(str);
                    }
                });
            });

            $('#listBtn').on('click', function () {

                $.get("/api/items", function (data) {
                    console.log(data);
                    alert(JSON.stringify(data));
                });
            });
            $('#readBtn').on('click', function () {
                var itemId = $('#itemId');
                var itemIdVal = itemId.val();

                $.ajax({
                    type: 'GET',
                    url: '/api/items/' + itemIdVal,
                    contentType: 'application/json;charset=UTF-8',
                    success: function (data) {
                        console.log(data);
                        alert(JSON.stringify(data));

                        $('#itemName').val(data.itemName);
                        $('#price').val(data.price);
                        $('#description').val(data.description);

                        $(".uploadedList").empty();

                        $.getJSON("/api/items/attach/"+data.itemId,function(list){

                            $(list).each(function(){
                                console.log("data : " + this);

                                var data = this;

                                var str ="";

                                if(checkImageType(data)){
                                    str = "<div><a href='/api/items/display?fileName=" + data + "'>"
                                        + "<img src='/api/items/display?fileName=" + getThumbnailName(data) + "'/>"
                                        + "</a><span>X</span></div>";
                                }
                                else{
                                    str = "<div><a href='/api/items/display?fileName=" + data + "'>"
                                        + getOriginalName(data) +"</a><span>X</span></div>";
                                }

                                $(".uploadedList").append(str);
                            });
                        });
                    },
                    error: function (request, status, error) {
                        alert('code: ' + request.status + '\n' + 'message: ' + request.responseText + '\n' + 'error: ' + error);
                    }
                });
            });
            $('#registerBtn').on('click', function () {
                console.log("change");

                var itemId = $("#itemId");
                var itemName = $("#itemName");
                var price = $("#price");
                var description = $("#description");

                var itemIdVal = itemId.val();
                var itemNameVal = itemName.val();
                var priceVal = price.val();
                var descriptionVal = description.val();

                var filenames =[];
                $(".uploadedList a").each(function(index){
                    var value = $(this).attr("href");

                    filenames[index] = value.split('fileName=')[1];

                });

                console.log("filenames = " + filenames);

                var itemObject = {
                    itemId : itemIdVal,
                    itemName : itemNameVal,
                    price : priceVal,
                    description : descriptionVal,
                    files : filenames
                };

                alert("JSON.stringify(itemObject) = " + JSON.stringify(itemObject));

                $.ajax({
                    type: 'POST',
                    url: '/api/items',
                    data : JSON.stringify(itemObject),
                    contentType : "application/json; charset=UTF-8",
                    success: function () {
                        alert("Created");
                    },
                    error: function (request, status, error) {
                        alert('code: ' + request.status + '\n' + 'message: ' + request.responseText + '\n' + 'error: ' + error);
                    }
                });
            });
            $('#deleteBtn').on('click', function () {
                var itemId = $('#itemId');
                var itemIdVal = itemId.val();

                $.ajax({
                    type: 'DELETE',
                    url: '/api/items/' + itemIdVal,
                    contentType : 'application/json; charset=UTF-8',
                    success: function () {
                        alert('Deleted');
                    },
                    error: function (request, status, error) {
                        alert('code: ' + request.status + '\n' + 'message: ' + request.responseText + '\n' + 'error: ' + error);
                    }
                });
            });
            $('#modifyBtn').on('click', function () {
                var itemId = $("#itemId");
                var itemName = $("#itemName");
                var price = $("#price");
                var description = $("#description");

                var itemIdVal = itemId.val();
                var itemNameVal = itemName.val();
                var priceVal = price.val();
                var descriptionVal = description.val();

                var filenames =[];
                $(".uploadedList a").each(function(index){
                    var value = $(this).attr("href");
                    value = value.substr(24);

                    filenames[index] = value;
                });

                console.log("filenames = " + filenames);

                var itemObject = {
                    itemId : itemIdVal,
                    itemName : itemNameVal,
                    price : priceVal,
                    description : descriptionVal,
                    files : filenames
                };

                $.ajax({
                    type: 'PUT',
                    url: '/api/items',
                    data: JSON.stringify(itemObject),
                    contentType : "application/json; charset=UTF-8",
                    success: function () {
                        alert('Modified');
                    },
                    error: function (request, status, error) {
                        alert('code: ' + request.status + '\n' + 'message: ' + request.responseText + '\n' + 'error: ' + error);
                    }
                });
            });
            $('#resetBtn').on('click', function () {
                $('#itemId').val('');
                $('#itemName').val('');
                $('#price').val('');
                $('#description').val('');

                $(".uploadedList").empty();
            });
        });
    </script>
</body>
</html>